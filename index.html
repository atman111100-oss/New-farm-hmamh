<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ุจุฑูุงูุฌ ุฅุฏุงุฑุฉ ูุฒุฑุนุฉ ุงูุฏูุงุฌู</title>
<!-- TailwindCSS CDN -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root{--card:#ffffff;}
  html{scroll-behavior:smooth}
  .card{background:var(--card)}
  .input{ @apply w-full rounded-xl border border-gray-300 px-3 py-2 bg-white text-gray-900; }
  .btn{ @apply px-3 py-2 rounded-xl; }
  .btn-primary{ @apply bg-emerald-600 text-white hover:bg-emerald-700; }
  .btn-secondary{ @apply bg-gray-100 hover:bg-gray-200; }
  .btn-danger{ @apply bg-red-100 text-red-700 hover:bg-red-200; }
  .table th,.table td{ @apply border-b border-gray-200 p-2 text-center align-middle; }
  @media (max-width:430px){ html{font-size:15px} }
</style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen">
  <!-- Header -->
  <header class="sticky top-0 z-30 backdrop-blur bg-white/80 border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-2">
        <span class="text-2xl">๐</span>
        <h1 class="font-extrabold text-lg sm:text-2xl">ุจุฑูุงูุฌ ุฅุฏุงุฑุฉ ูุฒุฑุนุฉ ุงูุฏูุงุฌู</h1>
      </div>
      <div class="flex items-center gap-2">
        <button id="toggleDark" class="btn btn-secondary">๐/โ๏ธ</button>
        <button id="btnExport" class="btn btn-secondary">โฌ๏ธ ุชุตุฏูุฑ</button>
        <label class="btn btn-secondary cursor-pointer">
          โฌ๏ธ ุงุณุชูุฑุงุฏ
          <input id="fileImport" type="file" accept="application/json" class="hidden">
        </label>
        <button id="btnClearAll" class="btn btn-danger">๐๏ธ ูุณุญ ุงููู</button>
      </div>
    </div>
  </header>

  <!-- Tabs -->
  <nav class="bg-white border-b">
    <div class="max-w-6xl mx-auto px-4 py-2 flex flex-wrap gap-2">
      <button class="tab btn btn-secondary" data-tab="overview">ูุธุฑุฉ ุนุงูุฉ</button>
      <button class="tab btn btn-secondary" data-tab="cycles">ุฏูุฑุงุช ุงูุฅูุชุงุฌ</button>
      <button class="tab btn btn-secondary" data-tab="daily">ุงูุชูุงุฑูุฑ ุงูููููุฉ</button>
      <button class="tab btn btn-secondary" data-tab="inventory">ุงููุฎุฒูู</button>
      <button class="tab btn btn-secondary" data-tab="purchases">ุงููุดุชุฑูุงุช</button>
      <button class="tab btn btn-secondary" data-tab="meds">ุงูุฃุฏููุฉ/ุงูููุงุญุงุช</button>
      <button class="tab btn btn-secondary" data-tab="costs">ุงูุชูุงููู ุงูุฃุฎุฑู</button>
      <button class="tab btn btn-secondary" data-tab="payroll">ุงูููุธููู ูุงูุฑูุงุชุจ</button>
      <button class="tab btn btn-secondary" data-tab="finance">ุงูููุฎุต ุงููุงูู</button>
      <button class="tab btn btn-secondary" data-tab="analytics">ุงูุชุญูููุงุช ูุงูููุงููุณ</button>
    </div>
  </nav>

  <main class="max-w-6xl mx-auto p-4 space-y-4">

    <!-- Overview -->
    <section id="tab-overview" class="card rounded-2xl p-4">
      <h2 class="text-xl font-bold mb-3">ููุญุฉ ูุนูููุงุช ุณุฑูุนุฉ</h2>
      <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-3">
        <div class="rounded-2xl border p-4">
          <div class="text-gray-500">ุงูุฏูุฑุฉ ุงููุดุทุฉ</div>
          <div id="ov-active" class="text-2xl font-bold">โ</div>
          <div id="ov-active-range" class="text-gray-500 text-sm">โ</div>
        </div>
        <div class="rounded-2xl border p-4">
          <div class="text-gray-500">ุนุฏุฏ ุงูุตูุต (ุฃููู / ุญู)</div>
          <div class="text-2xl font-bold"><span id="ov-initial">0</span> / <span id="ov-live">0</span></div>
        </div>
        <div class="rounded-2xl border p-4">
          <div class="text-gray-500">ุฅุฌูุงูู ุงูุนูู (ูุบ)</div>
          <div id="ov-feed" class="text-2xl font-bold">0</div>
        </div>
        <div class="rounded-2xl border p-4">
          <div class="text-gray-500">ุงููููู ุงูููู</div>
          <div id="ov-mort" class="text-2xl font-bold">0</div>
        </div>
      </div>
    </section>

    <!-- Cycles -->
    <section id="tab-cycles" class="card rounded-2xl p-4 hidden">
      <h2 class="text-xl font-bold mb-3">ุฅุฏุงุฑุฉ ุฏูุฑุงุช ุงูุฅูุชุงุฌ</h2>
      <form id="formCycle" class="grid sm:grid-cols-3 gap-3">
        <input class="input" id="cy_start" type="date" required>
        <input class="input" id="cy_breed" placeholder="ุงูุณูุงูุฉ (ุงุฎุชูุงุฑู)">
        <input class="input" id="cy_initial" type="number" min="1" placeholder="ุนุฏุฏ ุงูุตูุต ุงูุฃููู" required>
        <button class="btn btn-primary sm:col-span-3" type="submit">โ ุจุฏุก ุฏูุฑุฉ ุฌุฏูุฏุฉ</button>
      </form>

      <div class="mt-4">
        <h3 class="font-semibold mb-2">ุงูุฏูุฑุฉ ุงููุดุทุฉ</h3>
        <div id="activeCycleBox" class="rounded-2xl border p-3 text-sm text-gray-700">ูุง ุชูุฌุฏ ุฏูุฑุฉ ูุดุทุฉ</div>
        <div class="mt-2 flex gap-2">
          <button id="btnEndCycle" class="btn btn-danger">ุฅููุงุก ุงูุฏูุฑุฉ ุงูุญุงููุฉ</button>
        </div>
      </div>

      <div class="mt-6">
        <h3 class="font-semibold mb-2">ุงูุฏูุฑุงุช ุงูุณุงุจูุฉ</h3>
        <table class="table w-full text-sm">
          <thead><tr>
            <th>ุงูุฑูุฒ</th><th>ุงููุฏุฉ</th><th>ุฃููู/ููุงุฆู</th><th>ูููู</th><th>ุฅุฌูุงูู ุงูุชูุงููู</th><th>ุงูุฅูุฑุงุฏ</th><th>ููุฎุต</th>
          </tr></thead>
          <tbody id="tb-cycles"></tbody>
        </table>
      </div>
    </section>

    <!-- Daily reports -->
    <section id="tab-daily" class="card rounded-2xl p-4 hidden">
      <h2 class="text-xl font-bold mb-3">ุงูุชูุงุฑูุฑ ุงูููููุฉ</h2>
      <form id="formReport" class="grid sm:grid-cols-4 lg:grid-cols-8 gap-2">
        <input class="input" id="r_date" type="date" required>
        <input class="input" id="r_mort" type="number" min="0" placeholder="ูููู">
        <input class="input" id="r_feed" type="number" step="0.01" placeholder="ุนูู (ูุบ)">
        <input class="input" id="r_water" type="number" step="0.01" placeholder="ูุงุก (ูุชุฑ)">
        <input class="input" id="r_temp" type="number" step="0.1" placeholder="ยฐC">
        <input class="input" id="r_hum" type="number" step="0.1" placeholder="%RH">
        <input class="input" id="r_fuel" type="number" step="0.01" placeholder="ูููุฏ">
        <input class="input" id="r_wages" type="number" step="0.01" placeholder="ุฑูุงุชุจ">
        <input class="input lg:col-span-8" id="r_notes" placeholder="ููุงุญุธุงุช">
        <button class="btn btn-primary lg:col-span-8" type="submit">โ ุฅุถุงูุฉ ุชูุฑูุฑ</button>
      </form>

      <div class="flex items-center gap-2 mt-3">
        <input id="searchReports" class="input max-w-xs" placeholder="ุจุญุซ...">
        <span class="text-sm text-gray-500">ูุชู ุฑุจุท ุงูุชูุฑูุฑ ุจุงูุฏูุฑุฉ ุงููุดุทุฉ ุชููุงุฆููุง</span>
      </div>

      <table class="table w-full text-sm mt-3">
        <thead><tr>
          <th>ุงูุชุงุฑูุฎ</th><th>ูููู</th><th>ุนูู</th><th>ูุงุก</th><th>ยฐC</th><th>%RH</th><th>ูููุฏ</th><th>ุฑูุงุชุจ</th><th>ููุงุญุธุงุช</th><th>ุฅุฌุฑุงุกุงุช</th>
        </tr></thead>
        <tbody id="tb-reports"></tbody>
      </table>
    </section>

    <!-- Inventory -->
    <section id="tab-inventory" class="card rounded-2xl p-4 hidden">
      <h2 class="text-xl font-bold mb-3">ุฅุฏุงุฑุฉ ุงููุฎุฒูู</h2>
      <form id="formInv" class="grid sm:grid-cols-5 gap-2">
        <input class="input" id="i_name" placeholder="ุงูุตูู" required>
        <select class="input" id="i_type" required>
          <option value="" disabled selected>ุงูููุน</option>
          <option value="feed">ุนูู</option>
          <option value="fuel">ูููุฏ</option>
          <option value="med">ุฏูุงุก/ููุงุญ</option>
          <option value="mat">ููุงุฏ ุฃุฎุฑู</option>
        </select>
        <input class="input" id="i_qty" type="number" step="0.001" placeholder="ุงููููุฉ" required>
        <input class="input" id="i_unit" placeholder="ุงููุญุฏุฉ" required>
        <input class="input sm:col-span-5" id="i_notes" placeholder="ููุงุญุธุงุช">
        <button class="btn btn-primary sm:col-span-5" type="submit">โ ุฅุถุงูุฉ ุตูู</button>
      </form>

      <div class="flex items-center gap-2 mt-3">
        <input id="searchInv" class="input max-w-xs" placeholder="ุจุญุซ...">
      </div>

      <table class="table w-full text-sm mt-3">
        <thead><tr>
          <th>ุงูุตูู</th><th>ุงูููุน</th><th>ุงููููุฉ</th><th>ุงููุญุฏุฉ</th><th>ููุงุญุธุงุช</th><th>ุฅุฌุฑุงุกุงุช</th>
        </tr></thead>
        <tbody id="tb-inv"></tbody>
      </table>
    </section>

    <!-- Purchases -->
    <section id="tab-purchases" class="card rounded-2xl p-4 hidden">
      <h2 class="text-xl font-bold mb-3">ุงููุดุชุฑูุงุช</h2>
      <form id="formPur" class="grid sm:grid-cols-6 gap-2">
        <input class="input" id="p_date" type="date" required>
        <input class="input" id="p_item" placeholder="ุงูุตูู/ุงููุตู" required>
        <input class="input" id="p_qty" type="number" step="0.001" placeholder="ุงููููุฉ">
        <input class="input" id="p_unit" placeholder="ุงููุญุฏุฉ">
        <input class="input" id="p_price" type="number" step="0.01" placeholder="ุงูุณุนุฑ">
        <input class="input" id="p_trans" type="number" step="0.01" placeholder="ููู/ุชุญููู">
        <input class="input sm:col-span-6" id="p_notes" placeholder="ููุงุญุธุงุช">
        <button class="btn btn-primary sm:col-span-6" type="submit">โ ุฅุถุงูุฉ</button>
      </form>

      <table class="table w-full text-sm mt-3">
        <thead><tr>
          <th>ุงูุชุงุฑูุฎ</th><th>ุงููุตู</th><th>ูููุฉ</th><th>ุงููุญุฏุฉ</th><th>ุงูุณุนุฑ</th><th>ููู</th><th>ุงููุฌููุน</th><th>ุฅุฌุฑุงุกุงุช</th>
        </tr></thead>
        <tbody id="tb-pur"></tbody>
      </table>
    </section>

    <!-- Meds -->
    <section id="tab-meds" class="card rounded-2xl p-4 hidden">
      <h2 class="text-xl font-bold mb-3">ุงูุฃุฏููุฉ ูุงูููุงุญุงุช</h2>
      <form id="formMed" class="grid sm:grid-cols-5 gap-2">
        <input class="input" id="m_date" type="date" required>
        <input class="input" id="m_name" placeholder="ุงูุงุณู" required>
        <input class="input" id="m_qty" type="number" step="0.001" placeholder="ุงููููุฉ">
        <input class="input" id="m_price" type="number" step="0.01" placeholder="ุงูุณุนุฑ">
        <input class="input sm:col-span-5" id="m_notes" placeholder="ููุงุญุธุงุช">
        <button class="btn btn-primary sm:col-span-5" type="submit">โ ุฅุถุงูุฉ</button>
      </form>

      <table class="table w-full text-sm mt-3">
        <thead><tr>
          <th>ุงูุชุงุฑูุฎ</th><th>ุงูุงุณู</th><th>ุงููููุฉ</th><th>ุงูุณุนุฑ</th><th>ุงููุฌููุน</th><th>ุฅุฌุฑุงุกุงุช</th>
        </tr></thead>
        <tbody id="tb-med"></tbody>
      </table>
    </section>

    <!-- Other costs -->
    <section id="tab-costs" class="card rounded-2xl p-4 hidden">
      <h2 class="text-xl font-bold mb-3">ุงูุชูุงููู ุงูุฃุฎุฑู</h2>
      <form id="formCost" class="grid sm:grid-cols-4 gap-2">
        <input class="input" id="c_date" type="date" required>
        <input class="input" id="c_title" placeholder="ุงูุจูุฏ/ุงููุตู" required>
        <input class="input" id="c_amount" type="number" step="0.01" placeholder="ุงููุจูุบ" required>
        <input class="input sm:col-span-4" id="c_notes" placeholder="ููุงุญุธุงุช">
        <button class="btn btn-primary sm:col-span-4" type="submit">โ ุฅุถุงูุฉ</button>
      </form>

      <table class="table w-full text-sm mt-3">
        <thead><tr>
          <th>ุงูุชุงุฑูุฎ</th><th>ุงููุตู</th><th>ุงููุจูุบ</th><th>ุฅุฌุฑุงุกุงุช</th>
        </tr></thead>
        <tbody id="tb-cost"></tbody>
      </table>
    </section>

    <!-- Payroll -->
    <section id="tab-payroll" class="card rounded-2xl p-4 hidden">
      <h2 class="text-xl font-bold mb-3">ุงูููุธููู ูุงูุฑูุงุชุจ</h2>
      <form id="formEmp" class="grid sm:grid-cols-5 gap-2">
        <input class="input" id="e_name" placeholder="ุงูุงุณู" required>
        <input class="input" id="e_start" type="date" placeholder="ุจุฏุก" required>
        <input class="input" id="e_salary" type="number" step="0.01" placeholder="ุฑุงุชุจ ุดูุฑู" required>
        <input class="input" id="e_end" type="date" placeholder="ุงูุชูุงุก (ุงุฎุชูุงุฑู)">
        <input class="input sm:col-span-5" id="e_notes" placeholder="ููุงุญุธุงุช">
        <button class="btn btn-primary sm:col-span-5" type="submit">โ ุฅุถุงูุฉ ููุธู</button>
      </form>

      <table class="table w-full text-sm mt-3">
        <thead><tr>
          <th>ุงูุงุณู</th><th>ุงูุฑุงุชุจ</th><th>ุงููุชุฑุฉ</th><th>ููุงุญุธุงุช</th><th>ุฅุฌุฑุงุกุงุช</th>
        </tr></thead>
        <tbody id="tb-emp"></tbody>
      </table>

      <h3 class="font-semibold mt-6 mb-2">ุฏูุนุงุช ุงูุฑูุงุชุจ</h3>
      <form id="formPay" class="grid sm:grid-cols-4 gap-2">
        <select class="input" id="pay_emp" required></select>
        <input class="input" id="pay_date" type="date" required>
        <input class="input" id="pay_amount" type="number" step="0.01" placeholder="ุงููุจูุบ" required>
        <input class="input sm:col-span-4" id="pay_notes" placeholder="ููุงุญุธุงุช">
        <button class="btn btn-primary sm:col-span-4" type="submit">โ ุฅุถุงูุฉ ุฏูุนุฉ</button>
      </form>

      <table class="table w-full text-sm mt-3">
        <thead><tr>
          <th>ุงูููุธู</th><th>ุงูุชุงุฑูุฎ</th><th>ุงููุจูุบ</th><th>ุฅุฌุฑุงุกุงุช</th>
        </tr></thead>
        <tbody id="tb-pay"></tbody>
      </table>
    </section>

    <!-- Finance summary -->
    <section id="tab-finance" class="card rounded-2xl p-4 hidden">
      <h2 class="text-xl font-bold mb-3">ุงูููุฎุต ุงููุงูู (ููุฏูุฑุฉ ุงููุดุทุฉ)</h2>
      <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3 text-sm">
        <div class="rounded-2xl border p-3"><div class="text-gray-500">ุงููุดุชุฑูุงุช</div><div id="fn-pur" class="text-2xl font-bold">0</div></div>
        <div class="rounded-2xl border p-3"><div class="text-gray-500">ุงูุฃุฏููุฉ</div><div id="fn-med" class="text-2xl font-bold">0</div></div>
        <div class="rounded-2xl border p-3"><div class="text-gray-500">ุงูุชูุงููู ุงูุฃุฎุฑู</div><div id="fn-cost" class="text-2xl font-bold">0</div></div>
        <div class="rounded-2xl border p-3"><div class="text-gray-500">ุฑูุงุชุจ (ุฏูุนุงุช)</div><div id="fn-pay" class="text-2xl font-bold">0</div></div>
        <div class="rounded-2xl border p-3"><div class="text-gray-500">ุฑูุงุชุจ (ูููู)</div><div id="fn-wages" class="text-2xl font-bold">0</div></div>
        <div class="rounded-2xl border p-3 bg-emerald-50"><div class="text-gray-700">ุงูุฅุฌูุงูู</div><div id="fn-total" class="text-2xl font-extrabold text-emerald-700">0</div></div>
      </div>
    </section>

    <!-- Analytics -->
    <section id="tab-analytics" class="card rounded-2xl p-4 hidden">
      <h2 class="text-xl font-bold mb-3">ุงูุชุญูููุงุช ูุงูููุงููุณ</h2>
      <div class="grid sm:grid-cols-2 gap-4">
        <div class="rounded-2xl border p-4">
          <div class="text-sm text-gray-500 mb-2">ูุนุฏู ุงููููู</div>
          <div id="an-mortRate" class="text-2xl font-bold">โ</div>
        </div>
        <div class="rounded-2xl border p-4">
          <div class="text-sm text-gray-500 mb-2">ุงูุนูู/ุทูุฑ (ุชูุฑูุจู)</div>
          <div id="an-feedPerBird" class="text-2xl font-bold">โ</div>
        </div>
      </div>
      <div class="mt-4">
        <canvas id="chartDaily" height="130"></canvas>
      </div>
    </section>

  </main>

<script>
/* -------------------- ุงูุญุงูุฉ ุงูุนุงูุฉ -------------------- */
const LS_KEY = "broiler-farm-v1";
const state = load() || {
  cycles: [], activeCycleId: null,
  reports: [], inventory: [],
  purchases: [], meds: [], costs: [],
  employees: [], payments: [],
  dark: false
};

function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); refreshAll(); }
function load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)); }catch{ return null; }}

/* -------------------- ุฃุฏูุงุช ูุงุฌูุฉ -------------------- */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
function setTab(id){ $$('.tab').forEach(b=>b.classList.remove('bg-emerald-600','text-white')); $(`.tab[data-tab="${id}"]`).classList.add('bg-emerald-600','text-white'); $$('main section').forEach(s=>s.classList.add('hidden')); $(`#tab-${id}`).classList.remove('hidden'); }
$$('.tab').forEach(b=>b.addEventListener('click',()=>setTab(b.dataset.tab)));
setTab('overview');

/* Dark mode */
function applyDark(){
  if(state.dark){ document.documentElement.classList.add('dark'); document.body.classList.add('bg-gray-900','text-gray-100'); document.querySelectorAll('.card').forEach(c=>c.style.setProperty('--card','#0f172a')); }
  else{ document.documentElement.classList.remove('dark'); document.body.classList.remove('bg-gray-900','text-gray-100'); document.querySelectorAll('.card').forEach(c=>c.style.setProperty('--card','#ffffff')); }
}
$('#toggleDark').onclick=()=>{ state.dark=!state.dark; save(); };
applyDark();

/* -------------------- ุฏูุฑุงุช ุงูุฅูุชุงุฌ -------------------- */
function activeCycle(){ return state.cycles.find(c=>c.id===state.activeCycleId) || null; }

$('#formCycle').onsubmit = (e)=>{
  e.preventDefault();
  const cy = {
    id: crypto.randomUUID(),
    start: $('#cy_start').value,
    breed: $('#cy_breed').value.trim(),
    initial: Number($('#cy_initial').value||0),
    end: null, finalBirds: null, revenue: 0, notes: ''
  };
  state.cycles.push(cy);
  state.activeCycleId = cy.id;
  save();
  e.target.reset();
};

$('#btnEndCycle').onclick = ()=>{
  const cy = activeCycle();
  if(!cy){ alert('ูุง ุชูุฌุฏ ุฏูุฑุฉ ูุดุทุฉ'); return; }
  const finalBirds = prompt('ุงูุนุฏุฏ ุงูููุงุฆู ููุทููุฑ ุงูุญูุฉ ุนูุฏ ุงูุจูุนุ', (cy.initial - sumReports('mort')) || 0);
  if(finalBirds===null) return;
  const revenue = prompt('ูููุฉ ุงูุฅูุฑุงุฏ ุงูุฅุฌูุงูู ูู ุงูุจูุนุ', 0);
  cy.end = new Date().toISOString().slice(0,10);
  cy.finalBirds = Number(finalBirds||0);
  cy.revenue = Number(revenue||0);
  state.activeCycleId = null;
  save();
};

function renderCycles(){
  const box = $('#activeCycleBox');
  const cy = activeCycle();
  if(cy){
    const mort = sumReports('mort');
    const feed = sumReports('feed');
    box.innerHTML = `
      <div class="flex flex-col gap-1">
        <div><b>ุงูุจุฏุก:</b> ${cy.start} โ <b>ุงูุณูุงูุฉ:</b> ${cy.breed||'โ'}</div>
        <div><b>ุนุฏุฏ ุงูุตูุต ุงูุฃููู:</b> ${cy.initial} โ <b>ุงููููู ุญุชู ุงูุขู:</b> ${mort}</div>
        <div><b>ุงูุนูู ุงููุณุชุฎุฏู:</b> ${feed} ูุบ</div>
      </div>
    `;
  } else {
    box.textContent = 'ูุง ุชูุฌุฏ ุฏูุฑุฉ ูุดุทุฉ. ุงุจุฏุฃ ุฏูุฑุฉ ุฌุฏูุฏุฉ ุฃุนูุงู.';
  }

  const tb = $('#tb-cycles'); tb.innerHTML='';
  state.cycles.filter(c=>c.end).forEach(c=>{
    // ููุฎุต ุชูุงููู ุงูุฏูุฑุฉ (ุญุณุจ ูุทุงู ุงูุชูุงุฑูุฎ ุชูุฑูุจู)
    const costTotal = sumByRange(c.start,c.end);
    tb.insertAdjacentHTML('beforeend',`
      <tr>
        <td class="font-mono text-xs">${c.id.slice(0,8)}</td>
        <td>${c.start} โ ${c.end}</td>
        <td>${c.initial} / ${c.finalBirds??'โ'}</td>
        <td>${sumReports('mort',c.id)}</td>
        <td>${costTotal.toFixed(2)}</td>
        <td>${(c.revenue||0).toFixed(2)}</td>
        <td><button class="btn btn-secondary" onclick="alertCycle('${c.id}')">ุนุฑุถ</button></td>
      </tr>
    `);
  });
}
function alertCycle(id){
  const c = state.cycles.find(x=>x.id===id);
  if(!c) return;
  alert(
`ุฏูุฑุฉ: ${id}
ุงูุจุฏุก: ${c.start}
ุงูุงูุชูุงุก: ${c.end}
ุงูุฃููู: ${c.initial}
ุงูููุงุฆู: ${c.finalBirds}
ุงูุฅูุฑุงุฏ: ${c.revenue}
`
  );
}

/* -------------------- ุงูุชูุงุฑูุฑ ุงูููููุฉ -------------------- */
$('#r_date').value = new Date().toISOString().slice(0,10);

$('#formReport').onsubmit=(e)=>{
  e.preventDefault();
  const cy = activeCycle();
  if(!cy){ alert('ุงุจุฏุฃ ุฏูุฑุฉ ุฅูุชุงุฌ ุฃูููุง.'); return; }
  const row = {
    id: crypto.randomUUID(), cycleId: cy.id,
    date: $('#r_date').value,
    mort: Number($('#r_mort').value||0),
    feed: Number($('#r_feed').value||0),
    water:Number($('#r_water').value||0),
    temp: $('#r_temp').value===''?null:Number($('#r_temp').value),
    hum:  $('#r_hum').value===''?null:Number($('#r_hum').value),
    fuel: Number($('#r_fuel').value||0),
    wages:Number($('#r_wages').value||0),
    notes: $('#r_notes').value.trim()
  };
  state.reports.push(row); save(); e.target.reset(); $('#r_date').value=row.date;
};

$('#searchReports').oninput=()=>renderReports();

function renderReports(){
  const term = ($('#searchReports').value||'').toLowerCase();
  const tb = $('#tb-reports'); tb.innerHTML='';
  const cy = activeCycle();
  const list = state.reports.filter(r => (!cy || r.cycleId===cy.id) && (
    r.date.includes(term) || (r.notes||'').toLowerCase().includes(term)
  ));
  list.sort((a,b)=>a.date.localeCompare(b.date)).forEach(r=>{
    tb.insertAdjacentHTML('beforeend', `
      <tr>
        <td><span class="px-2 py-1 rounded bg-gray-100">${r.date}</span></td>
        <td>${r.mort}</td>
        <td>${r.feed}</td>
        <td>${r.water}</td>
        <td>${r.temp??''}</td>
        <td>${r.hum??''}</td>
        <td>${r.fuel}</td>
        <td>${r.wages}</td>
        <td class="max-w-[220px] truncate" title="${r.notes||''}">${r.notes||''}</td>
        <td class="space-x-0 space-y-1 flex flex-col">
          <button class="btn btn-secondary" onclick="editReport('${r.id}')">ุชุนุฏูู</button>
          <button class="btn btn-danger" onclick="delReport('${r.id}')">ุญุฐู</button>
        </td>
      </tr>
    `);
  });
}
function editReport(id){
  const r = state.reports.find(x=>x.id===id); if(!r) return;
  const mort=prompt('ูููู', r.mort); if(mort===null) return;
  const feed=prompt('ุนูู (ูุบ)', r.feed); if(feed===null) return;
  const water=prompt('ูุงุก (ูุชุฑ)', r.water); if(water===null) return;
  const notes=prompt('ููุงุญุธุงุช', r.notes||''); if(notes===null) return;
  r.mort=Number(mort||0); r.feed=Number(feed||0); r.water=Number(water||0); r.notes=notes.trim(); save();
}
function delReport(id){
  if(!confirm('ุญุฐู ุงูุชูุฑูุฑุ')) return;
  const i = state.reports.findIndex(x=>x.id===id);
  if(i>-1){ state.reports.splice(i,1); save(); }
}

/* -------------------- ุงููุฎุฒูู -------------------- */
$('#formInv').onsubmit=(e)=>{
  e.preventDefault();
  const it = {
    id: crypto.randomUUID(),
    name: $('#i_name').value.trim(),
    type: $('#i_type').value,
    qty:  Number($('#i_qty').value||0),
    unit: $('#i_unit').value.trim(),
    notes:$('#i_notes').value.trim()
  };
  state.inventory.push(it); save(); e.target.reset();
};
$('#searchInv').oninput=()=>renderInv();

function renderInv(){
  const term = ($('#searchInv').value||'').toLowerCase();
  const tb = $('#tb-inv'); tb.innerHTML='';
  state.inventory.filter(i=>i.name.toLowerCase().includes(term) || (i.notes||'').toLowerCase().includes(term))
  .forEach(i=>{
    tb.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${i.name}</td>
        <td>${({'feed':'ุนูู','fuel':'ูููุฏ','med':'ุฏูุงุก/ููุงุญ','mat':'ููุงุฏ ุฃุฎุฑู'})[i.type]||i.type}</td>
        <td>${i.qty}</td>
        <td>${i.unit}</td>
        <td class="max-w-[220px] truncate" title="${i.notes||''}">${i.notes||''}</td>
        <td class="flex flex-col gap-1">
          <button class="btn btn-secondary" onclick="editInv('${i.id}')">ุชุนุฏูู</button>
          <button class="btn btn-danger" onclick="delInv('${i.id}')">ุญุฐู</button>
        </td>
      </tr>
    `);
  });
}
function editInv(id){
  const i = state.inventory.find(x=>x.id===id); if(!i) return;
  const name = prompt('ุงูุตูู', i.name); if(name===null) return;
  const qty  = prompt('ุงููููุฉ', i.qty); if(qty===null) return;
  const unit = prompt('ุงููุญุฏุฉ', i.unit); if(unit===null) return;
  i.name = name.trim()||i.name; i.qty=Number(qty||0); i.unit=unit.trim()||i.unit; save();
}
function delInv(id){
  if(!confirm('ุญุฐู ุงูุตููุ')) return;
  const idx = state.inventory.findIndex(x=>x.id===id);
  if(idx>-1){ state.inventory.splice(idx,1); save(); }
}

/* -------------------- ุงููุดุชุฑูุงุช -------------------- */
$('#formPur').onsubmit=(e)=>{
  e.preventDefault();
  const row = {
    id: crypto.randomUUID(),
    date: $('#p_date').value,
    item: $('#p_item').value.trim(),
    qty:  Number($('#p_qty').value||0),
    unit: $('#p_unit').value.trim(),
    price:Number($('#p_price').value||0),
    trans:Number($('#p_trans').value||0),
    notes:$('#p_notes').value.trim()
  };
  state.purchases.push(row); save(); e.target.reset();
};
function renderPur(){
  const tb = $('#tb-pur'); tb.innerHTML='';
  state.purchases.sort((a,b)=>a.date.localeCompare(b.date)).forEach(p=>{
    const total = (p.price||0)+(p.trans||0);
    tb.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${p.date}</td>
        <td>${p.item}</td>
        <td>${p.qty}</td>
        <td>${p.unit}</td>
        <td>${p.price.toFixed(2)}</td>
        <td>${p.trans.toFixed(2)}</td>
        <td class="font-semibold">${total.toFixed(2)}</td>
        <td class="flex flex-col gap-1">
          <button class="btn btn-secondary" onclick="editPur('${p.id}')">ุชุนุฏูู</button>
          <button class="btn btn-danger" onclick="delPur('${p.id}')">ุญุฐู</button>
        </td>
      </tr>
    `);
  });
}
function editPur(id){
  const p = state.purchases.find(x=>x.id===id); if(!p) return;
  const price = prompt('ุงูุณุนุฑ', p.price); if(price===null) return;
  const trans = prompt('ููู/ุชุญููู', p.trans); if(trans===null) return;
  p.price=Number(price||0); p.trans=Number(trans||0); save();
}
function delPur(id){
  if(!confirm('ุญุฐู ุงูุณุฌูุ')) return;
  const i = state.purchases.findIndex(x=>x.id===id);
  if(i>-1){ state.purchases.splice(i,1); save(); }
}

/* -------------------- ุงูุฃุฏููุฉ -------------------- */
$('#formMed').onsubmit=(e)=>{
  e.preventDefault();
  const row = {
    id: crypto.randomUUID(),
    date: $('#m_date').value,
    name: $('#m_name').value.trim(),
    qty:  Number($('#m_qty').value||0),
    price:Number($('#m_price').value||0),
    notes:$('#m_notes').value.trim()
  };
  state.meds.push(row); save(); e.target.reset();
};
function renderMed(){
  const tb = $('#tb-med'); tb.innerHTML='';
  state.meds.sort((a,b)=>a.date.localeCompare(b.date)).forEach(m=>{
    const total = (m.price||0);
    tb.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${m.date}</td>
        <td>${m.name}</td>
        <td>${m.qty}</td>
        <td>${m.price.toFixed(2)}</td>
        <td class="font-semibold">${total.toFixed(2)}</td>
        <td class="flex flex-col gap-1">
          <button class="btn btn-secondary" onclick="editMed('${m.id}')">ุชุนุฏูู</button>
          <button class="btn btn-danger" onclick="delMed('${m.id}')">ุญุฐู</button>
        </td>
      </tr>
    `);
  });
}
function editMed(id){
  const m = state.meds.find(x=>x.id===id); if(!m) return;
  const price = prompt('ุงูุณุนุฑ', m.price); if(price===null) return;
  m.price = Number(price||0); save();
}
function delMed(id){
  if(!confirm('ุญุฐู ุงูุณุฌูุ')) return;
  const i = state.meds.findIndex(x=>x.id===id);
  if(i>-1){ state.meds.splice(i,1); save(); }
}

/* -------------------- ุงูุชูุงููู -------------------- */
$('#formCost').onsubmit=(e)=>{
  e.preventDefault();
  const row = { id: crypto.randomUUID(), date: $('#c_date').value, title: $('#c_title').value.trim(), amount: Number($('#c_amount').value||0), notes: $('#c_notes').value.trim() };
  state.costs.push(row); save(); e.target.reset();
};
function renderCost(){
  const tb = $('#tb-cost'); tb.innerHTML='';
  state.costs.sort((a,b)=>a.date.localeCompare(b.date)).forEach(c=>{
    tb.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${c.date}</td><td>${c.title}</td><td class="font-semibold">${c.amount.toFixed(2)}</td>
        <td class="flex flex-col gap-1">
          <button class="btn btn-secondary" onclick="editCost('${c.id}')">ุชุนุฏูู</button>
          <button class="btn btn-danger" onclick="delCost('${c.id}')">ุญุฐู</button>
        </td>
      </tr>
    `);
  });
}
function editCost(id){
  const c = state.costs.find(x=>x.id===id); if(!c) return;
  const v = prompt('ุงููุจูุบ', c.amount); if(v===null) return;
  c.amount = Number(v||0); save();
}
function delCost(id){
  if(!confirm('ุญุฐู ุงูุณุฌูุ')) return;
  const i = state.costs.findIndex(x=>x.id===id);
  if(i>-1){ state.costs.splice(i,1); save(); }
}

/* -------------------- ุงูููุธููู ูุงูุฑูุงุชุจ -------------------- */
$('#formEmp').onsubmit=(e)=>{
  e.preventDefault();
  const emp = {
    id: crypto.randomUUID(), name: $('#e_name').value.trim(),
    start: $('#e_start').value, salary: Number($('#e_salary').value||0),
    end: $('#e_end').value||null, notes: $('#e_notes').value.trim()
  };
  state.employees.push(emp); save(); e.target.reset();
};
$('#formPay').onsubmit=(e)=>{
  e.preventDefault();
  const p = { id: crypto.randomUUID(), empId: $('#pay_emp').value, date: $('#pay_date').value, amount: Number($('#pay_amount').value||0), notes: $('#pay_notes').value.trim() };
  state.payments.push(p); save(); e.target.reset();
};

function renderEmp(){
  // ุฌุฏูู ุงูููุธููู
  const tb = $('#tb-emp'); tb.innerHTML='';
  state.employees.forEach(emp=>{
    tb.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${emp.name}</td>
        <td>${emp.salary.toFixed(2)}</td>
        <td>${emp.start} โ ${emp.end||'โ'}</td>
        <td class="max-w-[220px] truncate" title="${emp.notes||''}">${emp.notes||''}</td>
        <td class="flex flex-col gap-1">
          <button class="btn btn-secondary" onclick="editEmp('${emp.id}')">ุชุนุฏูู</button>
          <button class="btn btn-danger" onclick="delEmp('${emp.id}')">ุญุฐู</button>
        </td>
      </tr>
    `);
  });

  // ูุงุฆูุฉ ุงุฎุชูุงุฑ ุงูุฏูุนุงุช
  const sel = $('#pay_emp'); sel.innerHTML = '<option value="" disabled selected>ุงุฎุชุฑ ููุธููุง</option>';
  state.employees.forEach(e=> sel.insertAdjacentHTML('beforeend', `<option value="${e.id}">${e.name}</option>`));

  // ุฌุฏูู ุงูุฏูุนุงุช
  const tbp = $('#tb-pay'); tbp.innerHTML='';
  state.payments.forEach(p=>{
    const name = (state.employees.find(e=>e.id===p.empId)||{}).name || 'โ';
    tbp.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${name}</td><td>${p.date}</td><td class="font-semibold">${p.amount.toFixed(2)}</td>
        <td class="flex flex-col gap-1">
          <button class="btn btn-secondary" onclick="editPay('${p.id}')">ุชุนุฏูู</button>
          <button class="btn btn-danger" onclick="delPay('${p.id}')">ุญุฐู</button>
        </td>
      </tr>
    `);
  });
}
function editEmp(id){
  const e = state.employees.find(x=>x.id===id); if(!e) return;
  const name = prompt('ุงูุงุณู', e.name); if(name===null) return;
  const sal  = prompt('ุงูุฑุงุชุจ ุงูุดูุฑู', e.salary); if(sal===null) return;
  e.name=name.trim()||e.name; e.salary=Number(sal||0); save();
}
function delEmp(id){
  if(!confirm('ุญุฐู ุงูููุธูุ')) return;
  state.employees = state.employees.filter(e=>e.id!==id);
  state.payments  = state.payments.filter(p=>p.empId!==id);
  save();
}
function editPay(id){
  const p = state.payments.find(x=>x.id===id); if(!p) return;
  const v = prompt('ุงููุจูุบ', p.amount); if(v===null) return;
  p.amount = Number(v||0); save();
}
function delPay(id){
  if(!confirm('ุญุฐู ุงูุฏูุนุฉุ')) return;
  state.payments = state.payments.filter(p=>p.id!==id); save();
}

/* -------------------- ุงูููุฎุต ุงููุงูู -------------------- */
function sum(array,sel){ return array.reduce((t,x)=>t+(+sel(x)||0),0); }
function sumByRange(start,end){
  const inRange = (d)=>(!start||d>=start)&&(!end||d<=end);
  const pur = sum(state.purchases.filter(x=>inRange(x.date)), x=>x.price+x.trans);
  const med = sum(state.meds.filter(x=>inRange(x.date)), x=>x.price);
  const cst = sum(state.costs.filter(x=>inRange(x.date)), x=>x.amount);
  const pay = sum(state.payments.filter(x=>inRange(x.date)), x=>x.amount);
  const wages = sum(state.reports.filter(x=>inRange(x.date)), x=>x.wages);
  return pur+med+cst+pay+wages;
}
function financeSummary(){
  const cy = activeCycle();
  let start, end;
  if(cy){ start = cy.start; end = cy.end || '9999-12-31'; }
  $('#fn-pur').textContent   = sum(state.purchases, x=>x.price+x.trans).toFixed(2);
  $('#fn-med').textContent   = sum(state.meds, x=>x.price).toFixed(2);
  $('#fn-cost').textContent  = sum(state.costs, x=>x.amount).toFixed(2);
  $('#fn-pay').textContent   = sum(state.payments, x=>x.amount).toFixed(2);
  $('#fn-wages').textContent = sum(state.reports, x=>x.wages).toFixed(2);
  const total = cy ? sumByRange(start,end) : (Number($('#fn-pur').textContent)+Number($('#fn-med').textContent)+Number($('#fn-cost').textContent)+Number($('#fn-pay').textContent)+Number($('#fn-wages').textContent));
  $('#fn-total').textContent = total.toFixed(2);
}

/* -------------------- ุงูุชุญูููุงุช -------------------- */
let chart;
function sumReports(field, onlyCycleId){
  const list = state.reports.filter(r=>!onlyCycleId || r.cycleId===onlyCycleId);
  return list.reduce((t,r)=>t+(+r[field]||0),0);
}
function analytics(){
  const cy = activeCycle();
  const initial = cy? cy.initial : 0;
  const mort = sumReports('mort', cy?cy.id:null);
  const feed = sumReports('feed', cy?cy.id:null);
  const live = Math.max(0, initial - mort);
  $('#an-mortRate').textContent = initial? ((mort/initial)*100).toFixed(2)+'%' : 'โ';
  $('#an-feedPerBird').textContent = live? (feed/live).toFixed(3)+' ูุบ/ุทูุฑ' : 'โ';

  // Chart
  const byDate = {};
  state.reports.filter(r=>!cy || r.cycleId===cy.id).forEach(r=>{
    byDate[r.date] = byDate[r.date] || {feed:0,mort:0};
    byDate[r.date].feed += +r.feed||0;
    byDate[r.date].mort += +r.mort||0;
  });
  const labels = Object.keys(byDate).sort();
  const feedArr = labels.map(d=>byDate[d].feed);
  const mortArr = labels.map(d=>byDate[d].mort);

  const ctx = document.getElementById('chartDaily');
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type:'line',
    data:{ labels, datasets:[
      {label:'ุนูู (ูุบ)', data:feedArr},
      {label:'ูููู (ุนุฏุฏ)', data:mortArr}
    ]},
    options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
  });
}

/* -------------------- ูุธุฑุฉ ุนุงูุฉ -------------------- */
function overview(){
  const cy = activeCycle();
  const ovActive = cy ? 'ูุดุทุฉ' : 'โ';
  $('#ov-active').textContent = ovActive;
  $('#ov-active-range').textContent = cy ? `${cy.start} โ ${cy.end||'ุฌุงุฑูุฉ'}` : 'โ';
  $('#ov-initial').textContent = cy? cy.initial : 0;
  const live = cy? Math.max(0, cy.initial - sumReports('mort', cy.id)) : 0;
  $('#ov-live').textContent = live;
  $('#ov-feed').textContent = cy? sumReports('feed', cy.id) : 0;
  $('#ov-mort').textContent = cy? sumReports('mort', cy.id) : 0;
}

/* -------------------- ุชุตุฏูุฑ/ุงุณุชูุฑุงุฏ/ูุณุญ -------------------- */
$('#btnExport').onclick = ()=>{
  const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `farm-backup-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
  a.click();
};
$('#fileImport').onchange = (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const rd = new FileReader();
  rd.onload = ()=>{
    try{
      const data = JSON.parse(rd.result);
      Object.assign(state, data); save();
      alert('ุชู ุงูุงุณุชูุฑุงุฏ ุจูุฌุงุญ');
    }catch{ alert('ููู ุบูุฑ ุตุงูุญ'); }
  };
  rd.readAsText(f);
  e.target.value='';
};
$('#btnClearAll').onclick = ()=>{
  if(confirm('ุณูุชู ูุณุญ ุฌููุน ุงูุจูุงูุงุช ุงููุญููุฉ. ุงุณุชูุฑุงุฑุ')){
    localStorage.removeItem(LS_KEY); location.reload();
  }
};

/* -------------------- ุงูุชุญุฏูุซ ุงูุนุงู ูููุงุฌูุฉ -------------------- */
function refreshAll(){
  applyDark();
  renderCycles();
  renderReports();
  renderInv();
  renderPur();
  renderMed();
  renderCost();
  renderEmp();
  financeSummary();
  analytics();
  overview();
}
refreshAll();
</script>
</body>
</html>
